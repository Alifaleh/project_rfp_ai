<odoo>
    <!-- Tile template removed as we are overriding the home page -->

    <template id="portal_breadcrumbs_rfp" inherit_id="portal.portal_breadcrumbs" priority="30">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'rfp_interface'" class="breadcrumb-item">
                <a href="/my">Projects</a>
            </li>
            <li t-if="page_name == 'rfp_interface'" class="breadcrumb-item active">
                <span t-field="rfp_project.name"/>
            </li>
        </xpath>
    </template>

    <template id="portal_my_rfps" name="My RFPs">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">RFP Projects</t>
            </t>

            <div class="row mb-3">
                <div class="col-12">
                    <a href="/my/rfp/start" class="btn btn-primary btn-lg">Start New Project</a>
                </div>
            </div>

            <t t-if="not projects">
                <p>There are no projects yet.</p>
            </t>
            <t t-if="projects">
                <div class="list-group">
                    <t t-foreach="projects" t-as="project">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h4 t-field="project.name"/>
                                <p t-field="project.description"/>
                                <span class="badge text-bg-info" t-field="project.current_stage"/>
                            </div>
                            <a t-attf-href="/rfp/interface/#{project.id}" class="btn btn-secondary">Resume</a>
                        </div>
                    </t>
                </div>
            </t>
        </t>
    </template>

    <template id="portal_rfp_wizard_start" name="Start RFP Wizard">
        <t t-call="portal.portal_layout">
            <div id="rfp_wizard_container">
                <h1>Start New Project Specification</h1>
                <p>Describe your idea to start the AI Interview.</p>
                <form action="/rfp/init" method="post">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <div class="mb-3">
                        <label>Project Name</label>
                        <input type="text" name="name" class="form-control" required="required"/>
                    </div>
                    <div class="mb-3">
                        <label>Language</label>
                        <select name="document_language" class="form-control" required="required">
                            <option value="en" selected="selected">English</option>
                            <option value="ar">Arabic</option>
                            <option value="fr">French</option>
                            <option value="es">Spanish</option>
                            <option value="de">German</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Initial Description</label>
                        <textarea name="description" class="form-control" rows="5" required="required"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Start Analysis</button>
                </form>
            </div>
        </t>
    </template>


    <template id="portal_rfp_document" name="Generated RFP Document">
        <t t-call="portal.portal_layout">
            <div class="container mt-4 mb-5">
                <div class="row">
                    <div class="col-12 text-end mb-3">
                        <a t-attf-href="/rfp/report/download/#{rfp_project.id}" class="btn btn-dark">
                            <i class="fa fa-print"/>
                            Download PDF Report
                        </a>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-lg">
                            <div class="card-body p-5">
                                <h1 class="display-4 text-center mb-5" t-field="rfp_project.name"/>
                                <hr/>

                                <t t-foreach="rfp_project.document_section_ids.sorted(lambda s: s.sequence)" t-as="section">
                                    <div class="mb-5">
                                        <!-- Section Content (Markdown rendering needed ideally, using simple output for MVP) -->
                                        <!-- In production we would use specific markdown renderer widget -->
                                            <div class="rfp-section-content"> <t t-out="section.content_markdown"/>
                                        </div>
                                    </div>
                                    <hr t-if="not section_last"/>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Integrate Mermaid.js for Diagrams -->
            <script type="module">
                import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
                mermaid.initialize({startOnLoad: true});
            </script>
        </t>
    </template>

    <template id="portal_rfp_input_field" name="RFP Input Field Component">
        <div
            class="mb-4 p-3 border rounded bg-light rfp-input-group position-relative" t-att-id="'input_group_' + input_field.field_key" t-att-data-field-key="input_field.field_key" t-att-data-depends-on="input_field.depends_on or '{}'" t-att-data-specify-triggers="input_field.specify_triggers or '[]'">

            <!-- Header: Label + Options Menu -->
            <div class="d-flex justify-content-between align-items-start mb-2">
                <label class="form-label fw-bold mb-0 text-dark flex-grow-1 me-3 text-wrap" style="word-break: break-word;">
                    <t t-esc="input_field.label"/>
                </label>

                <!-- Three Dots Menu -->
                <div class="dropdown">
                    <button class="btn btn-link text-decoration-none text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-ellipsis-v fa-lg"/>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item text-danger btn-irrelevant-toggle" href="#" t-att-data-target="'irrelevant_' + input_field.field_key">
                                <i class="fa fa-ban me-2"/>Skip Question
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <p class="text-muted small" t-if="input_field.data_type"><t t-esc="input_field.description_tooltip or ''"/></p>

            <!-- Dynamic Rendering Switch -->
            <t t-if="input_field.component_type == 'text_input'">
                <input type="text" t-att-name="input_field.field_key" class="form-control"/>
            </t>

            <t t-elif="input_field.component_type == 'number_input'">
                <input type="number" t-att-name="input_field.field_key" class="form-control"/>
            </t>

            <t t-elif="input_field.component_type == 'textarea'">
                <textarea t-att-name="input_field.field_key" class="form-control" rows="3"></textarea>
            </t>

            <t t-elif="input_field.component_type == 'select'">
                <select t-att-name="input_field.field_key" class="form-select">
                    <option value="">Select...</option>
                    <t t-if="input_field.get_options_parsed()">
                        <t t-foreach="input_field.get_options_parsed()" t-as="opt">
                            <option t-att-value="opt"><t t-esc="opt"/></option>
                        </t>
                    </t>
                </select>
            </t>

            <t t-elif="input_field.component_type == 'multiselect'">
                <div class="mb-2">
                    <small class="text-muted">Select all that apply:</small>
                    <t t-if="input_field.get_options_parsed()">
                        <t t-foreach="input_field.get_options_parsed()" t-as="opt">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" t-att-name="input_field.field_key" t-att-value="opt"/>
                                <label class="form-check-label"><t t-esc="opt"/></label>
                            </div>
                        </t>
                    </t>
                </div>
            </t>

            <t t-elif="input_field.component_type == 'radio'">
                <div class="rfp-radio-group">
                    <t t-if="input_field.get_options_parsed()">
                        <t t-foreach="input_field.get_options_parsed()" t-as="opt" t-as-index="opt_index">
                            <div class="form-check">
                                <input class="form-check-input rfp-dynamic-input" type="radio" t-att-name="input_field.field_key" t-att-id="input_field.field_key + '_' + str(opt_index)" t-att-value="opt" t-att-required="input_field.depends_on == '{}' or ''"/>
                                <label class="form-check-label" t-att-for="input_field.field_key + '_' + str(opt_index)">
                                    <t t-esc="opt"/>
                                </label>
                            </div>
                        </t>
                    </t>
                </div>
                <!-- Specify Input (Hidden by default) -->
                <input type="text" t-att-name="input_field.field_key + '_specify'" class="form-control mt-2 rfp-specify-input d-none" placeholder="Please specify..."/>
            </t>

            <t t-elif="input_field.component_type == 'boolean'">
                <div class="d-flex gap-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" t-att-name="input_field.field_key" value="yes" t-att-id="input_field.field_key + '_yes'"/>
                        <label class="form-check-label" t-att-for="input_field.field_key + '_yes'">
                            Yes
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" t-att-name="input_field.field_key" value="no" t-att-id="input_field.field_key + '_no'"/>
                        <label class="form-check-label" t-att-for="input_field.field_key + '_no'">
                            No
                        </label>
                    </div>
                </div>
            </t>

            <!-- Suggested Answers (Text/Textarea Only) -->
            <!-- Wrapped lines enabled with text-wrap and lh-sm classes -->
            <t t-if="input_field.suggested_answers and input_field.component_type in ['text_input', 'textarea']">
                <div class="mt-2 mb-2">
                    <small class="text-muted d-block mb-1">AI Suggestions (Click to fill):</small>
                    <div class="d-flex flex-column gap-2">
                        <t t-foreach="input_field.get_suggested_answers_parsed()" t-as="suggestion">
                            <div class="badge rounded-pill bg-info text-dark text-wrap text-start lh-sm border border-info cursor-pointer btn-suggestion p-2" style="cursor: pointer; max-width: 100%; white-space: normal;" t-att-data-value="suggestion" t-att-data-target="input_field.field_key">
                                <t t-esc="suggestion"/>
                            </div>
                        </t>
                    </div>
                </div>
            </t>

            <!-- Irrelevant Reason Field (Hidden by default) -->
            <div t-att-id="'irrelevant_' + input_field.field_key" class="mt-3 p-2 bg-warning bg-opacity-10 border border-warning rounded d-none irrelevant-box">
                <label class="form-label text-warning-emphasis small">Why is this irrelevant?</label>
                <div class="d-flex gap-2">
                    <input type="text" t-att-name="'irrelevant_reason_' + input_field.field_key" class="form-control form-control-sm" placeholder="e.g. We don't need this feature..."/>
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-irrelevant-cancel" t-att-data-target="'irrelevant_' + input_field.field_key">Cancel</button>
                </div>
                <input type="hidden" t-att-name="'is_irrelevant_' + input_field.field_key" value="false" class="irrelevant-flag"/>
            </div>
        </div>
    </template>

    <template id="portal_rfp_interface" name="AI Interviewer Interface">
        <t t-call="portal.portal_layout">
            <div
                class="container mt-4 rfp-portal-wrapper">
                <!-- Loading Overlay -->
                <div id="rfp_loading_overlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex justify-content-center align-items-center" style="z-index: 1050; backdrop-filter: blur(2px);">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h4 class="mt-3 text-primary">AI Analyst is thinking...</h4>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h3 t-field="rfp_project.name"/>
                                <span class="text-muted">AI Analyst is gathering requirements...</span>
                            </div>
                            <div
                                class="card-body">

                                <!-- Progress Bar -->
                                <t t-set="raw_score" t-value="rfp_project.get_context_data().get('analysis_meta', {}).get('completeness_score', 0)"/>
                                <t t-set="completeness" t-value="raw_score if raw_score > 1 else raw_score * 100"/>
                                <div class="progress mb-4" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" t-att-style="'width: ' + str(int(completeness)) + '%'" t-att-aria-valuenow="int(completeness)" aria-valuemin="0" aria-valuemax="100">
                                        <t t-esc="int(completeness)"/>% Analysis Complete
                                    </div>
                                </div>

                                <!-- Rate Limit Alert (Global Top) -->
                                <t t-set="ai_status" t-value="rfp_project.get_context_data().get('analysis_meta', {}).get('status')"/>

                                <div t-if="ai_status == 'rate_limit'" class="alert alert-warning mb-3">
                                    <h4 class="alert-heading h5"><i class="fa fa-clock-o"/>
                                        System Busy (Rate Limit)</h4>
                                    <p class="mb-0">The AI service is experiencing high traffic. Please wait 30 seconds before retrying.</p>
                                    <div class="progress mt-2 mb-2" style="height: 5px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" role="progressbar" style="width: 100%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted">This is normal for the free tier.</small>
                                        <form t-attf-action="/rfp/next_step/#{rfp_project.id}" method="post">
                                            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                            <button type="submit" class="btn btn-sm btn-warning">Retry Now</button>
                                        </form>
                                    </div>
                                </div>

                                <!-- Error Alert (Global Top) -->
                                <div t-if="ai_status == 'error'" class="alert alert-danger mb-3">
                                    <h4 class="alert-heading h5"><i class="fa fa-exclamation-triangle"/>
                                        Analysis Interrupted</h4>
                                    <p class="mb-2">Reference:
                                        <t t-esc="rfp_project.get_context_data().get('research_notes', 'Unknown Error')"/></p>
                                    <a t-attf-href="/rfp/interface/#{rfp_project.id}" class="btn btn-sm btn-outline-danger">Retry Analysis</a>
                                </div>

                                <!-- Info Box (Hidden on Rate Limit) -->
                                <t t-set="unanswered_ids" t-value="rfp_project.form_input_ids.filtered(lambda i: not i.user_value and not i.is_irrelevant)"/>
                                <div class="alert alert-info" t-if="unanswered_ids and ai_status != 'rate_limit'">
                                    <i class="fa fa-info-circle"/>
                                    The AI has analyzed your project and needs the following details to proceed.
                                </div>

                                <form t-attf-action="/rfp/next_step/#{rfp_project.id}" method="post">
                                    <input
                                    type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                                    <!-- Render Questions -->
                                    <t t-if="unanswered_ids and ai_status != 'rate_limit'">
                                        <t t-foreach="unanswered_ids" t-as="input_field">
                                            <t t-call="project_rfp_ai.portal_rfp_input_field"/>
                                        </t>

                                        <div class="d-grid gap-2 mb-3">
                                            <button type="submit" class="btn btn-primary btn-lg">Submit Answers &amp; Continue Analysis</button>
                                        </div>
                                    </t>

                                    <!-- Checkpoint State (No unanswered, but not done) -->
                                    <t t-if="not unanswered_ids and rfp_project.current_stage == 'gathering' and ai_status != 'rate_limit'">
                                        <div class="alert alert-warning text-center">
                                            <h4><i class="fa fa-refresh"/>
                                                Analysis Checkpoint</h4>
                                            <p>All current questions have been answered.</p>
                                            <p>Click below to generate the next round of questions or finalize the document.</p>
                                        </div>
                                        <div class="d-grid gap-2 mb-3">
                                            <button type="submit" class="btn btn-success btn-lg">Generate Next Questions</button>
                                        </div>
                                    </t>

                                    <!-- Done State -->
                                    <div t-if="rfp_project.current_stage == 'generating' and ai_status != 'rate_limit'" class="alert alert-success text-center">
                                        <h4><i class="fa fa-check-circle"/>
                                            Gap Analysis Complete!</h4>
                                        <p>The AI has gathered all necessary requirements.</p>
                                        <div class="d-grid gap-2 mt-3">
                                            <a t-attf-href="/rfp/generate_proposal/#{rfp_project.id}" class="btn btn-success btn-lg">Generate Proposal Document</a>
                                        </div>
                                    </div>

                                </form>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="portal_rfp_document" name="Generated RFP Document">
        <t t-call="portal.portal_layout">
            <div class="container mt-4 mb-5">
                <div class="row">
                    <div class="col-12 text-end mb-3">
                        <a t-attf-href="/rfp/report/download/#{rfp_project.id}" class="btn btn-dark">
                            <i class="fa fa-print"/>
                            Download PDF Report
                        </a>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-lg">
                            <div class="card-body p-5">
                                <h1 class="display-4 text-center mb-5" t-field="rfp_project.name"/>
                                <hr/>

                                <t t-foreach="rfp_project.document_section_ids.sorted(lambda s: s.sequence)" t-as="section">
                                    <div class="mb-5">
                                        <div class="rfp-section-content">
                                            <t t-out="section.content_markdown"/>
                                        </div>
                                    </div>
                                    <hr t-if="not section_last"/>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Integrate Mermaid.js for Diagrams -->
            <script type="module">
                import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
                mermaid.initialize({startOnLoad: true});
            </script>
        </t>
    </template>
</odoo>
