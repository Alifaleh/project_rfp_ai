<odoo>
    <!-- Tile template removed as we are overriding the home page -->

    <template id="portal_breadcrumbs_rfp" inherit_id="portal.portal_breadcrumbs" priority="30">
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
            <li t-if="page_name == 'rfp_interface'" class="breadcrumb-item">
                <a href="/my">Projects</a>
            </li>
            <li t-if="page_name == 'rfp_interface'" class="breadcrumb-item active">
                <span t-field="rfp_project.name"/>
            </li>
        </xpath>
    </template>

    <!-- NEW COMPONENT: Loading Overlay -->
    <template id="rfp_loading_overlay_component" name="RFP Loading Overlay">
        <div id="rfp_loading_overlay" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex justify-content-center align-items-center" style="z-index: 1050; backdrop-filter: blur(2px);">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h4 class="mt-3 text-primary">AI Analyst is thinking...</h4>
                <p class="text-muted small">Please do not refresh the page.</p>
            </div>
        </div>
    </template>

    <template id="portal_my_rfps" name="My RFPs">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">RFP Projects</t>
            </t>

            <div class="row mb-3">
                <div class="col-12">
                    <a href="/rfp/start" class="btn btn-primary btn-lg">Start New Project</a>
                </div>
            </div>

            <t t-if="not projects">
                <p>There are no projects yet.</p>
            </t>
            <t t-if="projects">
                <div class="list-group">
                    <t t-foreach="projects" t-as="project">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h4 t-field="project.name"/>
                                <p t-field="project.description"/>
                                <span class="badge text-bg-info" t-field="project.current_stage"/>
                            </div>
                            <a t-attf-href="/rfp/interface/#{project.id}" class="btn btn-secondary">Resume</a>
                        </div>
                    </t>
                </div>
            </t>
        </t>
    </template>

    <template id="portal_rfp_start" name="Start RFP Wizard">
        <t t-call="portal.portal_layout">
            <div id="rfp_wizard_container" class="container rfp-portal-wrapper">
                <t t-call="project_rfp_ai.rfp_loading_overlay_component"/>
                <h1>Start New Project Specification</h1>
                <p>Describe your idea to start the AI Interview.</p>
                <form action="/rfp/init" method="post">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    <div class="mb-3">
                        <label>Project Name</label>
                        <input type="text" name="name" class="form-control" required="required"/>
                    </div>
                    
                    <div class="mb-3">
                        <label>Initial Description</label>
                        <textarea name="description" class="form-control" rows="4" placeholder="Describe your high-level goal used for the RFP generation..." required="required"></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Start Analysis</button>
                    </div>
                </form>
            </div>
        </t>
    </template>




    <template id="portal_rfp_input_field" name="RFP Input Field Component">
        <div
            class="mb-4 p-3 border rounded bg-light rfp-input-group position-relative" t-att-id="'input_group_' + input_field.field_key" t-att-data-field-key="input_field.field_key" t-att-data-depends-on="input_field.depends_on or '{}'" t-att-data-specify-triggers="input_field.specify_triggers or '[]'">

            <!-- Header: Label + Options Menu -->
            <div class="d-flex justify-content-between align-items-start mb-2">
                <label class="form-label fw-bold mb-0 text-dark flex-grow-1 me-3 text-wrap" style="word-break: break-word;">
                    <t t-esc="input_field.label"/>
                </label>

                <!-- Three Dots Menu -->
                <div class="dropdown">
                    <button class="btn btn-link text-decoration-none text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fa fa-ellipsis-v fa-lg"/>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item text-primary btn-custom-answer-toggle" href="#" t-att-data-target="'custom_answer_' + input_field.field_key" t-if="input_field.component_type not in ['text_input', 'textarea', 'number_input']">
                                <i class="fa fa-pencil me-2"/>Custom Answer
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item text-danger btn-irrelevant-toggle" href="#" t-att-data-target="'irrelevant_' + input_field.field_key">
                                <i class="fa fa-ban me-2"/>Skip Question
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <p class="text-muted small" t-if="input_field.data_type"><t t-esc="input_field.description_tooltip or ''"/></p>

            <!-- Dynamic Rendering Switch -->
            <t t-if="input_field.component_type == 'text_input'">
                <input type="text" t-att-name="input_field.field_key" class="form-control"/>
            </t>

            <t t-elif="input_field.component_type == 'number_input'">
                <input type="number" t-att-name="input_field.field_key" class="form-control"/>
            </t>

            <t t-elif="input_field.component_type == 'textarea'">
                <textarea t-att-name="input_field.field_key" class="form-control" rows="3"></textarea>
            </t>

            <t t-elif="input_field.component_type == 'select'">
                <select t-att-name="input_field.field_key" class="form-select">
                    <option value="">Select...</option>
                    <t t-if="input_field.get_options_parsed()">
                        <t t-foreach="input_field.get_options_parsed()" t-as="opt">
                            <t t-if="isinstance(opt, dict)">
                                <option t-att-value="opt['value']"><t t-esc="opt['label']"/></option>
                            </t>
                            <t t-else="">
                                <option t-att-value="opt"><t t-esc="opt"/></option>
                            </t>
                        </t>
                    </t>
                </select>
            </t>

            <t t-elif="input_field.component_type == 'multiselect'">
                <div class="mb-2">
                    <small class="text-muted">Select all that apply:</small>
                    <t t-if="input_field.get_options_parsed()">
                        <t t-foreach="input_field.get_options_parsed()" t-as="opt">
                             <t t-set="opt_val" t-value="opt['value'] if isinstance(opt, dict) else opt"/>
                             <t t-set="opt_label" t-value="opt['label'] if isinstance(opt, dict) else opt"/>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" t-att-name="input_field.field_key" t-att-value="opt_val"/>
                                <label class="form-check-label"><t t-esc="opt_label"/></label>
                            </div>
                        </t>
                    </t>
                </div>
                <!-- Specify Input (Hidden by default) -->
                <input type="text" t-att-name="input_field.field_key + '_specify'" class="form-control mt-2 rfp-specify-input d-none" placeholder="Please specify..."/>
            </t>

            <t t-elif="input_field.component_type == 'radio'">
                <div class="rfp-radio-group">
                    <t t-if="input_field.get_options_parsed()">
                        <t t-foreach="input_field.get_options_parsed()" t-as="opt" t-as-index="opt_index">
                            <t t-set="opt_val" t-value="opt['value'] if isinstance(opt, dict) else opt"/>
                            <t t-set="opt_label" t-value="opt['label'] if isinstance(opt, dict) else opt"/>
                            <div class="form-check">
                                <input class="form-check-input rfp-dynamic-input" type="radio" t-att-name="input_field.field_key" t-att-id="input_field.field_key + '_' + str(opt_index)" t-att-value="opt_val" t-att-required="input_field.depends_on == '{}' or ''"/>
                                <label class="form-check-label" t-att-for="input_field.field_key + '_' + str(opt_index)">
                                    <t t-esc="opt_label"/>
                                </label>
                            </div>
                        </t>
                    </t>
                </div>
                <!-- Specify Input (Hidden by default) -->
                <input type="text" t-att-name="input_field.field_key + '_specify'" class="form-control mt-2 rfp-specify-input d-none" placeholder="Please specify..."/>
            </t>

            <t t-elif="input_field.component_type == 'boolean'">
                <div class="d-flex gap-4">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" t-att-name="input_field.field_key" value="yes" t-att-id="input_field.field_key + '_yes'"/>
                        <label class="form-check-label" t-att-for="input_field.field_key + '_yes'">
                            Yes
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" t-att-name="input_field.field_key" value="no" t-att-id="input_field.field_key + '_no'"/>
                        <label class="form-check-label" t-att-for="input_field.field_key + '_no'">
                            No
                        </label>
                    </div>
                </div>
            </t>

            <!-- Suggested Answers (Text/Textarea Only) -->
            <!-- Wrapped lines enabled with text-wrap and lh-sm classes -->
            <t t-if="input_field.get_suggested_answers_parsed() and input_field.component_type in ['text_input', 'textarea']">
                <div class="mt-2 mb-2">
                    <small class="text-muted d-block mb-1">AI Suggestions (Click to fill):</small>
                    <div class="d-flex flex-column gap-2">
                        <t t-foreach="input_field.get_suggested_answers_parsed()" t-as="suggestion">
                            <div class="badge rounded-pill bg-info text-dark text-wrap text-start lh-sm border border-info cursor-pointer btn-suggestion p-2" style="cursor: pointer; max-width: 100%; white-space: normal;" t-att-data-value="suggestion" t-att-data-target="input_field.field_key">
                                <t t-esc="suggestion"/>
                            </div>
                        </t>
                    </div>
                </div>
            </t>

            <!-- Irrelevant Reason Field (Hidden by default) -->
            <div t-att-id="'irrelevant_' + input_field.field_key" class="mt-3 p-2 bg-warning bg-opacity-10 border border-warning rounded d-none irrelevant-box">
                <label class="form-label text-warning-emphasis small">Why is this irrelevant?</label>
                <div class="d-flex gap-2">
                    <input type="text" t-att-name="'irrelevant_reason_' + input_field.field_key" class="form-control form-control-sm" placeholder="e.g. We don't need this feature..."/>
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-irrelevant-cancel" t-att-data-target="'irrelevant_' + input_field.field_key">Cancel</button>
                </div>
                <input type="hidden" t-att-name="'is_irrelevant_' + input_field.field_key" value="false" class="irrelevant-flag"/>
            </div>

            <!-- Custom Answer Field (Hidden by default) -->
            <div t-att-id="'custom_answer_' + input_field.field_key" class="mt-3 p-2 bg-info bg-opacity-10 border border-info rounded d-none custom-answer-box">
                <label class="form-label text-info-emphasis small">Custom Answer</label>
                <div class="d-flex gap-2">
                    <input type="text" t-att-name="'custom_answer_val_' + input_field.field_key" class="form-control form-control-sm" placeholder="Type your answer here..."/>
                    <button type="button" class="btn btn-sm btn-outline-secondary btn-custom-answer-cancel" t-att-data-target="'custom_answer_' + input_field.field_key">Cancel</button>
                </div>
                <input type="hidden" t-att-name="'has_custom_answer_' + input_field.field_key" value="false" class="custom-answer-flag"/>
            </div>
        </div>
    </template>

    <template id="portal_rfp_interface" name="AI Interviewer Interface">
        <t t-call="portal.portal_layout">
            <div class="container mt-4 rfp-portal-wrapper">
                
                <!-- USE COMPONENT -->
                <t t-call="project_rfp_ai.rfp_loading_overlay_component"/>

                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h3 t-field="rfp_project.name"/>
                                <span class="text-muted">AI Analyst is gathering requirements...</span>
                            </div>
                            <div class="card-body">

                                <!-- Progress Bar -->
                                <t t-set="raw_score" t-value="rfp_project.get_context_data().get('analysis_meta', {}).get('completeness_score', 0)"/>
                                <t t-set="completeness" t-value="raw_score if raw_score > 1 else raw_score * 100"/>
                                <div t-if="rfp_project.current_stage == 'initialized' and rfp_project.ai_context_blob" class="progress mb-4" style="height: 25px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" role="progressbar" t-att-style="'width: ' + str(int(completeness)) + '%'" t-att-aria-valuenow="int(completeness)" aria-valuemin="0" aria-valuemax="100">
                                        <t t-esc="int(completeness)"/>% Analysis Complete
                                    </div>
                                </div>

                                <!-- Status Alerts -->
                                <t t-set="ai_status" t-value="rfp_project.get_context_data().get('analysis_meta', {}).get('status')"/>

                                <div t-if="ai_status == 'rate_limit'" class="alert alert-warning mb-3">
                                    <h4 class="alert-heading h5"><i class="fa fa-clock-o"/> System Busy (Rate Limit)</h4>
                                    <p class="mb-0">The AI service is experiencing high traffic. Please wait 30 seconds before retrying.</p>
                                    <form t-attf-action="/rfp/next_step/#{rfp_project.id}" method="post" class="mt-2">
                                        <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                        <button type="submit" class="btn btn-sm btn-warning">Retry Now</button>
                                    </form>
                                </div>

                                <div t-if="ai_status == 'error'" class="alert alert-danger mb-3">
                                    <h4 class="alert-heading h5"><i class="fa fa-exclamation-triangle"/> Analysis Interrupted</h4>
                                    <p class="mb-2">Reference: <t t-esc="rfp_project.get_context_data().get('research_notes', 'Unknown Error')"/></p>
                                    <a t-attf-href="/rfp/interface/#{rfp_project.id}" class="btn btn-sm btn-outline-danger">Retry Analysis</a>
                                </div>

                                <!-- Questions Form (Data Driven from Controller 'questions_to_answer') -->
                                <form t-attf-action="/rfp/next_step/#{rfp_project.id}" method="post">
                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>

                                    <t t-if="questions_to_answer and ai_status != 'rate_limit'">
                                        <div class="alert alert-info">
                                            <i class="fa fa-info-circle"/> The AI has analyzed your project and needs details.
                                        </div>
                                        
                                        <t t-foreach="questions_to_answer" t-as="input_field">
                                            <t t-call="project_rfp_ai.portal_rfp_input_field"/>
                                        </t>

                                        <div class="d-grid gap-2 mb-3">
                                            <button type="submit" class="btn btn-primary btn-lg">Submit Answers &amp; Continue</button>
                                        </div>
                                    </t>
                                    
                                    <!-- Checkpoint / Proceed (No Questions but not finished) -->
                                    <t t-elif="not questions_to_answer and ai_status != 'rate_limit' and not is_generating">
                                         <div class="alert alert-warning text-center">
                                            <h4><i class="fa fa-refresh"/> Analysis Checkpoint</h4>
                                            <p>All current questions have been answered.</p>
                                            <p>Proceed to the next phase.</p>
                                        </div>
                                        <div class="d-grid gap-2 mb-3">
                                            <button type="submit" class="btn btn-success btn-lg">Generate Next Round</button>
                                        </div>
                                    </t>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- PHASE 2: UNIFIED PROCESSING STATUS -->
    <template id="portal_rfp_processing" name="RFP Processing Status">
        <t t-call="portal.portal_layout">
            <div class="container mt-5 text-center rfp-portal-wrapper">
                <div class="card shadow p-5">
                    <h2 class="mb-4">AI Architect is Working...</h2>
                    <p class="lead text-muted mb-4">We are autonomously building your RFP document. This involves structurizing, writing, and designing.</p>

                    <!-- Steps Visual -->
                    <div class="row justify-content-center mb-5">
                        <div class="col-md-8">
                            <ul class="list-group list-group-flush text-start" id="rfp_step_list">
                                <li class="list-group-item d-flex justify-content-between align-items-center" id="step_structure">
                                    <span><i class="fa fa-sitemap me-2"/> 1. Designing Structure</span>
                                    <span class="badge rounded-pill bg-secondary status-badge">Pending</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center" id="step_content">
                                    <span><i class="fa fa-pencil me-2"/> 2. Writing Content</span>
                                    <span class="badge rounded-pill bg-secondary status-badge">Pending</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center" id="step_images">
                                    <span><i class="fa fa-image me-2"/> 3. Drawing Diagrams</span>
                                    <span class="badge rounded-pill bg-secondary status-badge">Pending</span>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="progress mt-2 mb-3" style="height: 30px;">
                        <div id="rfp_generation_progress" class="progress-bar progress-bar-striped progress-bar-animated bg-primary" role="progressbar" style="width: 0%" t-att-data-project-id="rfp_project.id">
                            0%
                        </div>
                    </div>
                    <p id="rfp_status_text" class="small text-muted">Initializing...</p>
                </div>
            </div>
        </t>
    </template>

    <!-- PHASE 3: UNIFIED EDITOR (SPA) -->
    <template id="portal_rfp_unified_editor" name="RFP Unified Editor">
        <t t-call="portal.portal_layout">
            <!-- Load Quill.js -->
            <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet"/>
            <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

            <div class="container-fluid mt-4 mb-5 rfp-portal-wrapper">
                
                <!-- Toolbar -->
                <div class="d-flex justify-content-between align-items-center mb-4 sticky-top bg-white p-3 shadow-sm rounded border z-index-1000">
                    <div class="d-flex align-items-center gap-3">
                        <h3 class="mb-0" t-field="rfp_project.name"/>
                        <span t-if="rfp_project.current_stage == 'completed'" class="badge bg-success">Ready</span>
                        <span t-if="rfp_project.current_stage == 'document_locked'" class="badge bg-dark"><i class="fa fa-lock"/> Locked</span>
                    </div>
                    
                    <div class="d-flex gap-2">
                         <a t-attf-href="/rfp/download/word/#{rfp_project.id}" class="btn btn-outline-primary">
                            <i class="fa fa-file-word-o"/> Word
                        </a>
                        <button onclick="window.print()" class="btn btn-outline-dark">
                            <i class="fa fa-print"/> Print
                        </button>
                        
                        <div class="vr mx-2"></div>

                        <t t-if="rfp_project.current_stage != 'document_locked'">
                            <button id="btn_unified_save" class="btn btn-primary" t-att-data-project-id="rfp_project.id">
                                <i class="fa fa-save"/> Save Changes
                            </button>
                            <button id="btn_toggle_lock" class="btn btn-warning" t-att-data-project-id="rfp_project.id" data-locked="true">
                                <i class="fa fa-lock"/> Lock Document
                            </button>
                        </t>
                        <t t-else="">
                            <button id="btn_toggle_lock" class="btn btn-secondary" t-att-data-project-id="rfp_project.id" data-locked="false">
                                <i class="fa fa-unlock"/> Unlock to Edit
                            </button>
                        </t>
                    </div>
                </div>

                <div class="row">
                    <!-- Main Editor Area -->
                    <div class="col-12">
                        <div id="rfp_unified_container" class="bg-light p-3 rounded">
                            
                            <!-- Draggable List -->
                            <div id="rfp_section_list" class="d-flex flex-column gap-4">
                                <t t-foreach="rfp_project.document_section_ids.sorted('sequence')" t-as="section">
                                    <div class="card shadow-sm rfp-section-block" t-att-data-section-id="section.id" draggable="true">
                                        <!-- Header -->
                                        <div class="card-header bg-white d-flex align-items-center gap-3 p-3 handle" style="cursor: move;">
                                            <i class="fa fa-bars text-muted fa-lg"/>
                                            <input type="text" class="form-control form-control-lg fw-bold border-0 bg-transparent section-title-input" t-att-value="section.section_title" placeholder="Section Title"/>
                                            <div class="ms-auto d-flex gap-1">
                                                <button class="btn btn-sm btn-light border btn-ai-edit-section" style="min-width: 55px;" t-att-data-section-id="section.id" title="Edit with AI" t-att-disabled="rfp_project.current_stage == 'document_locked'">
                                                    <i class="fa fa-magic text-primary"/> AI
                                                </button>
                                                <button class="btn btn-sm text-danger btn-delete-section" t-att-disabled="rfp_project.current_stage == 'document_locked'">
                                                    <i class="fa fa-trash"/>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Content Body -->
                                        <div class="card-body p-0">
                                            <div class="rfp-quill-editor bg-white border-bottom" style="min-height: 200px;" t-att-id="'editor_' + str(section.id)">
                                                <t t-out="section.content_html"/>
                                            </div>
                                        </div>

                                        <!-- Images Footer -->
                                        <div class="card-footer bg-light p-3">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="text-muted small text-uppercase fw-bold mb-0">Diagrams &amp; Visuals</h6>
                                                <button class="btn btn-sm btn-outline-primary btn-upload-diagram-trigger" t-att-data-section-id="section.id" t-att-disabled="rfp_project.current_stage == 'document_locked'">
                                                    <i class="fa fa-upload"/> Add Image
                                                </button>
                                                <input type="file" class="d-none rfp-diagram-upload-input" accept="image/*" t-att-data-section-id="section.id"/>
                                            </div>
                                            
                                            <div class="row g-3 diagrams-container" t-att-id="'diagrams-container-' + str(section.id)">
                                                <t t-if="section.diagram_ids">
                                                    <t t-foreach="section.diagram_ids" t-as="diagram">
                                                        <div class="col-md-4 col-sm-6 diagram-wrapper" t-att-data-diagram-id="diagram.id">
                                                            <div class="card h-100 border-0 shadow-sm diagram-card">
                                                                <div class="position-relative">
                                                                    <img t-if="diagram.image_file" t-att-src="'/web/image/rfp.section.diagram/%s/image_file' % diagram.id" class="card-img-top object-fit-cover" style="height: 150px; cursor: pointer;"/>
                                                                    <div t-else="" class="card-img-top bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 150px;">
                                                                        <i class="fa fa-image fa-2x"/>
                                                                    </div>
                                                                    
                                                                    <!-- Overlay Actions -->
                                                                    <div class="position-absolute top-0 end-0 p-2 d-flex gap-1" t-if="rfp_project.current_stage != 'document_locked'">
                                                                        <button class="btn btn-sm btn-light text-primary shadow-sm btn-ai-edit-diagram" t-att-data-diagram-id="diagram.id" title="Edit with AI">
                                                                            <i class="fa fa-magic"/>
                                                                        </button>
                                                                        <button class="btn btn-sm btn-light text-danger shadow-sm btn-delete-diagram" t-att-data-diagram-id="diagram.id" title="Delete Image">
                                                                            <i class="fa fa-trash"/>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div class="card-body p-2">
                                                                    <p class="card-text small text-muted text-truncate mb-0" t-att-title="diagram.description">
                                                                        <t t-esc="diagram.description"/>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </t>
                                                </t>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </div>
                            
                            <!-- Add Section Button -->
                            <div class="text-center mt-4">
                                <button id="btn_add_section" class="btn btn-outline-secondary dashed-border w-50 py-3">
                                    <i class="fa fa-plus-circle fa-lg mb-2"/><br/>
                                    Add New Section
                                </button>
                            </div>

                        </div>
                    </div>
                </div>
                
                <!-- Hidden Template for New Sections (cloned by JS) -->
                <div id="section_template_clone" class="d-none">
                    <div class="card shadow-sm rfp-section-block mb-4" data-section-id="0" draggable="true">
                        <!-- Header -->
                        <div class="card-header bg-white d-flex align-items-center gap-3 p-3 handle" style="cursor: move;">
                            <i class="fa fa-bars text-muted fa-lg"/>
                            <input type="text" class="form-control form-control-lg fw-bold border-0 bg-transparent section-title-input" value="" placeholder="Section Title"/>
                            <button class="btn btn-sm text-danger btn-delete-section ms-auto">
                                <i class="fa fa-trash"/>
                            </button>
                        </div>
        
                        <!-- Content Body -->
                        <div class="card-body p-0">
                            <div class="rfp-quill-editor bg-white border-bottom" style="min-height: 200px;"></div>
                        </div>
        
                        <!-- Images Footer -->
                        <div class="card-footer bg-light p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-muted small text-uppercase fw-bold mb-0">Diagrams &amp; Visuals</h6>
                                <button class="btn btn-sm btn-outline-primary btn-upload-diagram-trigger">
                                    <i class="fa fa-upload"/> Add Image
                                </button>
                                <input type="file" class="d-none rfp-diagram-upload-input" accept="image/*"/>
                            </div>
                            <div class="row g-3 diagrams-container"></div>
                        </div>
                    </div>
                </div>
        
                <!-- Lock Confirmation Modal -->
                <div class="modal fade" id="modal_lock_confirm" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header border-0 pb-0">
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center pt-0">
                                <div class="mb-3">
                                    <i class="fa fa-lock fa-4x text-warning"></i>
                                </div>
                                <h4>Lock Document?</h4>
                                <p class="text-muted">
                                    Locking the document will prevent further edits. you can unlock it later but it is better to finish everything before locking.
                                </p>
                            </div>
                            <div class="modal-footer justify-content-center border-0">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary px-4" id="btn_confirm_lock_action">Yes, Lock it!</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Diagram Modal -->
                <div class="modal fade" id="modal_upload_diagram" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Diagram</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="form_upload_diagram">
                                    <input type="hidden" id="upload_section_id" name="section_id"/>
                                    <div class="mb-3">
                                        <label class="form-label">Title <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="upload_diagram_title" name="title" required="required"/>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea class="form-control" id="upload_diagram_desc" name="description" rows="3" required="required"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Image File <span class="text-danger">*</span></label>
                                        <input type="file" class="form-control" id="upload_diagram_file" name="image_file" accept="image/*" required="required"/>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="btn_save_diagram">Upload</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div class="modal fade" id="modal_delete_confirm" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
                        <div class="modal-content">
                            <div class="modal-header border-0 pb-0">
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center pt-0">
                                <div class="mb-3">
                                    <i class="fa fa-trash fa-3x text-danger"></i>
                                </div>
                                <h5 id="delete_confirm_title">Delete Item?</h5>
                                <p class="text-muted small" id="delete_confirm_message">This action cannot be undone.</p>
                                <input type="hidden" id="delete_target_type"/>
                                <input type="hidden" id="delete_target_id"/>
                            </div>
                            <div class="modal-footer justify-content-center border-0 pt-0">
                                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-danger btn-sm px-4" id="btn_confirm_delete">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Viewer Modal -->
                <div class="modal fade" id="modal_image_viewer" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
                        <div class="modal-content bg-dark">
                            <div class="modal-header border-0">
                                <h6 class="modal-title text-white" id="image_viewer_title">Image Preview</h6>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center p-2">
                                <img id="image_viewer_img" src="" class="img-fluid rounded" style="max-height: 70vh;" alt="Preview"/>
                            </div>
                            <div class="modal-footer border-0 justify-content-center">
                                <a id="image_viewer_download" href="" download="" class="btn btn-light">
                                    <i class="fa fa-download"></i> Download
                                </a>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Edit Modal -->
                <div class="modal fade" id="modal_ai_edit" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fa fa-magic text-primary"></i> Edit with AI
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-muted small" id="ai_edit_context_label">Describe how you want to modify the content:</p>
                                <textarea class="form-control" id="ai_edit_prompt" rows="4" placeholder="E.g., Make it more formal, add bullet points, focus on security aspects..."></textarea>
                                <input type="hidden" id="ai_edit_type"/>
                                <input type="hidden" id="ai_edit_target_id"/>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="btn_submit_ai_edit">
                                    <i class="fa fa-magic"></i> Apply AI Edit
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Modal (Success/Error) -->
                <div class="modal fade" id="modal_notification" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
                        <div class="modal-content">
                            <div class="modal-body text-center py-4">
                                <div class="mb-3">
                                    <i id="notification_icon" class="fa fa-3x"></i>
                                </div>
                                <h5 id="notification_title">Notification</h5>
                                <p class="text-muted small mb-0" id="notification_message"></p>
                            </div>
                            <div class="modal-footer justify-content-center border-0 pt-0">
                                <button type="button" class="btn btn-primary btn-sm px-4" data-bs-dismiss="modal">OK</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>


    </template>



    <template id="portal_rfp_document" name="Generated RFP Document">
        <t t-call="portal.portal_layout">
            <style>
                .rfp-section-content h3 {
                    font-size: 1.25rem !important; /* Smaller than h2 (usually 2rem) */
                    color: #444;
                    margin-top: 1.5rem;
                }
                @media print {
                    header, footer, #top_menu, .o_footer, .breadcrumb, .btn-group, .text-end, .btn {
                        display: none !important;
                    }
                    body {
                        background-color: white !important;
                        padding-top: 0 !important;
                    }
                    .container {
                        max-width: 100% !important; 
                        width: 100% !important; 
                        margin: 0 !important; 
                        padding: 0 !important;
                    }
                    .card {
                        box-shadow: none !important; 
                        border: none !important;
                    }
                }
            </style>
            <div class="container mt-4 mb-5">
                <div class="row">
                    <div class="col-12 text-end mb-3">
                        <div class="btn-group">

                            <button onclick="window.print()" class="btn btn-outline-dark">
                                <i class="fa fa-print"/>
                                Print PDF
                            </button>
                            <a t-attf-href="/rfp/download/word/#{rfp_project.id}" class="btn btn-outline-primary">
                                <i class="fa fa-file-word-o"/>
                                Word (.doc)
                            </a>
                        </div>
                        <a t-attf-href="/rfp/revert_to_edit/#{rfp_project.id}" class="btn btn-secondary ms-2">
                            <i class="fa fa-pencil"/>
                            Edit
                        </a>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-lg">
                            <div class="card-body p-5">
                                <h1 class="display-4 text-center mb-5" t-field="rfp_project.name"/>
                                <hr/>

                                <t t-foreach="rfp_project.document_section_ids.sorted(lambda s: s.sequence)" t-as="section">
                                    <div class="mb-5">
                                        <h2 t-field="section.section_title" class="mb-3"/>
                                        <div class="rfp-section-content" t-field="section.content_html"/>
                                        
                                        <!-- Attached Diagrams -->
                                        <t t-if="section.diagram_ids">
                                            <div class="mt-4">
                                                <t t-foreach="section.diagram_ids" t-as="diagram">
                                                    <figure class="text-center mb-4" t-if="diagram.image_file">
                                                        <img t-att-src="'/web/image/rfp.section.diagram/%s/image_file' % diagram.id" class="img-fluid rounded shadow-sm border" style="max-height: 600px;"/>
                                                        <figcaption class="mt-2 text-muted fst-italic">
                                                            <strong t-esc="diagram.title"/>
                                                        </figcaption>
                                                    </figure>
                                                </t>
                                            </div>
                                        </t>
                                    </div>
                                    <hr t-if="not section_last"/>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Integrate Mermaid.js for Diagrams -->
            <script type="module">
                import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
                mermaid.initialize({startOnLoad: true});
            </script>
        </t>
    </template>
</odoo>
